#include "test/common.h"

TEST_IMPL(field_add) {
  curve25519_num_t a;
  curve25519_num_t b;
  uint8_t bin[32];

  /* Add with carry */
  {
    uint8_t initial[32] = {
      0xec, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f
    };

    uint8_t expected[32] = {
      0xeb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f
    };

    curve25519_num_from_bin(&a, initial);
    curve25519_num_from_bin(&b, initial);

    curve25519_num_add(&a, &b);

    curve25519_num_to_bin(bin, &a);
    check_equal_data(bin, expected, sizeof(bin),
                     "Addition should give right result with carry");
  }

  /* Add without full carry */
  {
    uint8_t initial[32] = {
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x00
    };

    uint8_t one[32] = {
      0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };

    uint8_t expected[32] = {
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00
    };

    curve25519_num_from_bin(&a, initial);
    curve25519_num_from_bin(&b, one);

    curve25519_num_add(&a, &b);

    curve25519_num_to_bin(bin, &a);
    check_equal_data(bin, expected, sizeof(bin),
                     "Addition should give right result without full carry");
  }
}
