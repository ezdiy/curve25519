#include "test/common.h"

static test_field_vector_t add_vectors[] = {
  {
    .a = {
      0xec, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f
    },
    .b = {
      0xec, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f
    },
    .expected = {
      0xeb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f
    },
    .description = "double with carry"
  },
  {
    .a = {
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
      0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f, 0x00
    },
    .b = {
      0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    },
    .expected = {
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0x00
    },
    .description = "partial carry"
  },
  {
    .a = {
      0x43, 0xfb, 0xb0, 0xaf, 0x9f, 0x7a, 0x97, 0xde,
      0x61, 0xcc, 0x48, 0x92, 0x4b, 0xf2, 0xc6, 0x6a,
      0x1e, 0xe8, 0x6f, 0x1e, 0x74, 0x67, 0xb9, 0xe9,
      0x9c, 0x37, 0xf0, 0xe4, 0xa6, 0x8a, 0x64, 0x3b
    },
    .b = {
      0x93, 0x7c, 0x5f, 0xae, 0x79, 0x48, 0xa3, 0x22,
      0xf2, 0x2e, 0x17, 0xfc, 0x7e, 0xb4, 0x51, 0x99,
      0x62, 0x8a, 0xc8, 0x02, 0x0b, 0x32, 0x52, 0xb9,
      0x7e, 0xd9, 0x78, 0x22, 0xaa, 0xd1, 0xc7, 0x2b
    },
    .expected = {
      0xd6, 0x77, 0x10, 0x5e, 0x19, 0xc3, 0x3a, 0x01,
      0x54, 0xfb, 0x5f, 0x8e, 0xca, 0xa6, 0x18, 0x04,
      0x81, 0x72, 0x38, 0x21, 0x7f, 0x99, 0x0b, 0xa3,
      0x1b, 0x11, 0x69, 0x07, 0x51, 0x5c, 0x2c, 0x67
    },
    .description = "random data"
  }
};

TEST_IMPL(field_add) {
  unsigned int i;

  for (i = 0; i < ARRAY_SIZE(add_vectors); i++) {
    curve25519_num_t a;
    curve25519_num_t b;
    uint8_t bin[32];

    curve25519_num_from_bin(&a, add_vectors[i].a);
    curve25519_num_from_bin(&b, add_vectors[i].b);
    curve25519_num_add(&a, &a, &b);
    curve25519_num_to_bin(bin, &a);

    check_equal_data(bin, add_vectors[i].expected, sizeof(bin),
                     add_vectors[i].description);
  }
}
