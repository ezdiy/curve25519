#include "test/common.h"

static const test_ed_point_unpack_vector_t unpack_vectors[] = {
  {
    .bin = {
      0x9d, 0x95, 0xd6, 0x08, 0x87, 0xfe, 0x40, 0x9b,
      0x43, 0x23, 0x7f, 0x39, 0x76, 0x70, 0x9b, 0xbd,
      0x32, 0x3f, 0xdd, 0x15, 0x83, 0x6d, 0x4e, 0x47,
      0x36, 0xe8, 0xe0, 0x60, 0x73, 0xa7, 0x5e, 0x4a
    },
    .expected = {
      .x = {
        0xa4, 0xb7, 0xd6, 0x06, 0x6e, 0xaa, 0xba, 0xc6,
        0xf3, 0xe7, 0xe6, 0x19, 0x58, 0xb5, 0xc6, 0x28,
        0xfe, 0x01, 0x30, 0x02, 0x82, 0x18, 0x41, 0xc4,
        0x3b, 0xc4, 0xc6, 0xa5, 0xf9, 0xaa, 0x37, 0x78
      },
      .y = {
        0x9d, 0x95, 0xd6, 0x08, 0x87, 0xfe, 0x40, 0x9b,
        0x43, 0x23, 0x7f, 0x39, 0x76, 0x70, 0x9b, 0xbd,
        0x32, 0x3f, 0xdd, 0x15, 0x83, 0x6d, 0x4e, 0x47,
        0x36, 0xe8, 0xe0, 0x60, 0x73, 0xa7, 0x5e, 0x4a
      }
    },
    .description = "unpack even"
  },
  {
    .bin = {
      0xe4, 0xa6, 0x98, 0x10, 0xf7, 0x72, 0xc8, 0x0f,
      0x0b, 0x18, 0x18, 0xc1, 0x8e, 0xd1, 0xf4, 0xf4,
      0xe4, 0x47, 0x67, 0xd9, 0xaf, 0x90, 0x88, 0x05,
      0x85, 0x28, 0x40, 0xce, 0xf3, 0xcb, 0x17, 0xc3
    },
    .expected = {
      .x = {
        0xe3, 0x88, 0xcc, 0x90, 0x80, 0x21, 0x83, 0xe1,
        0x0a, 0x29, 0xaa, 0x87, 0x75, 0x73, 0x13, 0xf7,
        0x88, 0xbd, 0x55, 0x8b, 0x98, 0x01, 0x00, 0x69,
        0x4e, 0xcb, 0x9a, 0xda, 0xb3, 0x74, 0x54, 0x72
      },
      .y = {
        0xe4, 0xa6, 0x98, 0x10, 0xf7, 0x72, 0xc8, 0x0f,
        0x0b, 0x18, 0x18, 0xc1, 0x8e, 0xd1, 0xf4, 0xf4,
        0xe4, 0x47, 0x67, 0xd9, 0xaf, 0x90, 0x88, 0x05,
        0x85, 0x28, 0x40, 0xce, 0xf3, 0xcb, 0x17, 0x43
      }
    },
    .description = "unpack odd"
  }
};

TEST_IMPL(ed_point_unpack) {
  unsigned int i;

  for (i = 0; i < ARRAY_SIZE(unpack_vectors); i++) {
    const test_ed_point_unpack_vector_t* vec;
    curve25519_ed_point_t p;
    curve25519_num_t expected_t;
    uint8_t bin[32];

    vec = &unpack_vectors[i];

    CHECK_EQ(curve25519_ed_point_from_bin(&p, vec->bin), 0,
             "curve25519_ed_point_from_bin");
    CHECK_EQ(p.normalized, 1, "point must be normalized after unpack");

    curve25519_num_to_bin(bin, &p.x);
    check_equal_data(bin, vec->expected.x, sizeof(bin), vec->description);

    curve25519_num_to_bin(bin, &p.y);
    check_equal_data(bin, vec->expected.y, sizeof(bin), vec->description);

    CHECK(curve25519_num_is_one(&p.z), "z must be one after unpack");

    curve25519_num_mul(&expected_t, &p.x, &p.y);
    CHECK_EQ(curve25519_num_ncmp(&p.t, &expected_t), 0,
             "t = x * y after unpack");

    curve25519_ed_point_to_bin(bin, &p);
    check_equal_data(bin, vec->bin, sizeof(bin), vec->description);
  }
}
